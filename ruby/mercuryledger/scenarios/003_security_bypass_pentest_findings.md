# Scenario 003: Security Vulnerability Assessment Report

## NCC Group Penetration Test Findings
**Assessment Date:** November 2024
**Classification:** CONFIDENTIAL - INTERNAL ONLY
**Report ID:** NCC-ML-2024-Q4-SEC

---

### Finding SEC-001: Path Traversal via URL Encoding (HIGH)

**Vulnerability Class:** CWE-22 Path Traversal
**CVSS Score:** 7.5 (High)

**Description:**
The `sanitise_path` function in the Security module can be bypassed using URL-encoded directory traversal sequences. While the function correctly strips literal `..` sequences, it does not perform URL decoding before sanitization.

**Proof of Concept:**
```
Request: GET /api/manifests/%2e%2e/%2e%2e/etc/passwd
Expected: Blocked or sanitized to safe path
Actual: Request processed, path traversal successful
```

The encoded `%2e%2e` (which decodes to `..`) passes through the sanitization filter.

**Business Impact:** Attackers could access sensitive manifest files, configuration data, or internal documentation outside the intended directory scope.

---

### Finding SEC-002: Origin Validation Case Sensitivity (MEDIUM)

**Vulnerability Class:** CWE-178 Improper Handling of Case Sensitivity
**CVSS Score:** 5.3 (Medium)

**Description:**
The `allowed_origin?` check performs a case-sensitive comparison against the allowlist. This allows bypass via case manipulation.

**Proof of Concept:**
```
Allowed: https://mercury.internal
Tested:  HTTPS://MERCURY.INTERNAL
Result:  Origin check bypassed
```

**Business Impact:** Cross-origin resource sharing restrictions can be circumvented, potentially enabling CSRF attacks from malicious domains.

---

### Finding SEC-003: Token Scope Bypass (HIGH)

**Vulnerability Class:** CWE-863 Incorrect Authorization
**CVSS Score:** 8.1 (High)

**Description:**
The TokenStore `valid?` method only checks token existence and expiry, but does not validate the token's scope against the requested operation. A token issued for read-only manifest viewing can be used to invoke administrative commands.

**Proof of Concept:**
```ruby
# Token issued with scope: "manifest:read"
# Used to call: dispatch_emergency_override (requires scope: "dispatch:admin")
# Result: Operation permitted
```

**Business Impact:** Privilege escalation allowing read-only users to perform administrative operations including emergency dispatches, berth overrides, and settlement approvals.

---

### Finding SEC-004: Weak Secret Acceptance (MEDIUM)

**Vulnerability Class:** CWE-521 Weak Password Requirements
**CVSS Score:** 5.9 (Medium)

**Description:**
The `sign_manifest` function does not enforce minimum secret length. Manifests signed with weak secrets (e.g., 4-character strings) are accepted, making brute-force attacks feasible.

**Proof of Concept:**
```ruby
# These should be rejected:
sign_manifest("VESSEL-001", 50000, "abc")   # 3 chars - accepted
sign_manifest("VESSEL-001", 50000, "1234")  # 4 chars - accepted
```

**Business Impact:** Manifest signatures can be forged through brute-force attacks on weak secrets, enabling cargo data manipulation.

---

### Finding SEC-005: Command Replay Attack (HIGH)

**Vulnerability Class:** CWE-294 Authentication Bypass by Capture-replay
**CVSS Score:** 7.4 (High)

**Description:**
The `authorize_command` function in the Security Service does not implement replay protection. Captured commands can be replayed indefinitely without timestamp or nonce validation.

**Test Case Reference:**
```
FAILED: test_command_replay_protection
  Expected: reject replayed command (same timestamp/nonce)
  Actual: command accepted on replay
```

**Business Impact:** Captured settlement approval commands could be replayed to duplicate transfers or re-authorize previously cancelled operations.

---

### Remediation Priority Matrix

| Finding | Severity | Exploitability | Business Risk | Priority |
|---------|----------|----------------|---------------|----------|
| SEC-001 | High | Easy | Critical | P1 |
| SEC-003 | High | Moderate | Critical | P1 |
| SEC-005 | High | Moderate | High | P2 |
| SEC-002 | Medium | Easy | Moderate | P2 |
| SEC-004 | Medium | Hard | Moderate | P3 |

---

### Related Test Failures

The following automated tests are currently failing:

- `test_sanitise_path_url_encoded_traversal`
- `test_allowed_origin_case_insensitive`
- `test_token_scope_validation`
- `test_sign_manifest_minimum_secret_length`
- `test_command_replay_protection`

---

### Auditor Notes

These findings represent a subset of the security module issues identified. Additional concerns around signature verification order and digest input validation were noted but require further investigation.

**Next Steps:** Engineering team to review Security module (`lib/mercuryledger/core/security.rb`) and Security Service (`services/security/service.rb`) for comprehensive remediation.
