FROM mcr.microsoft.com/dotnet/sdk:8.0
WORKDIR /app
COPY EventHorizon.sln .
COPY src/Shared/Shared.csproj src/Shared/
COPY src/Gateway/Gateway.csproj src/Gateway/
COPY src/Auth/Auth.csproj src/Auth/
COPY src/Events/Events.csproj src/Events/
COPY src/Tickets/Tickets.csproj src/Tickets/
COPY src/Orders/Orders.csproj src/Orders/
COPY src/Payments/Payments.csproj src/Payments/
COPY src/Venues/Venues.csproj src/Venues/
COPY src/Notifications/Notifications.csproj src/Notifications/
COPY src/Analytics/Analytics.csproj src/Analytics/
COPY src/Search/Search.csproj src/Search/
COPY tests/Shared.Tests/Shared.Tests.csproj tests/Shared.Tests/
COPY tests/Gateway.Tests/Gateway.Tests.csproj tests/Gateway.Tests/
COPY tests/Auth.Tests/Auth.Tests.csproj tests/Auth.Tests/
COPY tests/Events.Tests/Events.Tests.csproj tests/Events.Tests/
COPY tests/Tickets.Tests/Tickets.Tests.csproj tests/Tickets.Tests/
COPY tests/Orders.Tests/Orders.Tests.csproj tests/Orders.Tests/
COPY tests/Payments.Tests/Payments.Tests.csproj tests/Payments.Tests/
COPY tests/Venues.Tests/Venues.Tests.csproj tests/Venues.Tests/
COPY tests/Notifications.Tests/Notifications.Tests.csproj tests/Notifications.Tests/
COPY tests/Analytics.Tests/Analytics.Tests.csproj tests/Analytics.Tests/
COPY tests/Search.Tests/Search.Tests.csproj tests/Search.Tests/
RUN dotnet restore

COPY src/ ./src/
COPY tests/ ./tests/

ENV ConnectionStrings__DefaultConnection="Host=postgres;Port=5432;Database=eventhorizon;Username=eventhorizon;Password=eventhorizon"
ENV ConnectionStrings__Redis="redis:6379"
ENV RabbitMq__Host="rabbitmq"
ENV Consul__Host="consul"
ENV ASPNETCORE_ENVIRONMENT=Test

CMD ["dotnet", "test", "--logger", "trx;LogFileName=results.trx", "--no-restore", "-v", "minimal"]
